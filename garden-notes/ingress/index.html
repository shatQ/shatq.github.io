<!doctype html>
<html lang="en">
<head>
<title>Ingress</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script async type="module">import mermaid from"https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs"</script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-sv0slik/5O0JIPdLBCR2A3XDg/1U3WuDEheZfI/DI5n8Yqc3h5kjrnr46FGBNiUAJF7rE4LHKwQ/SoSLRKAxEA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script async src="https://cdn.jsdelivr.net/npm/lucide@0.115.0/dist/umd/lucide.min.js"></script>
<script>window.addEventListener("load",(()=>{document.querySelectorAll(".callout").forEach((e=>{const t=getComputedStyle(e).getPropertyValue("--callout-icon"),l=t&&t.trim().replace(/^lucide-/,"");if(l){const t=e.querySelector(".callout-title");if(t){const e=document.createElement("div"),c=document.createElement("i");e.appendChild(c),c.setAttribute("icon-name",l),e.setAttribute("class","callout-icon"),t.insertBefore(e,t.firstChild)}}})),lucide.createIcons(),Array.from(document.querySelectorAll(".callout.is-collapsible")).forEach((e=>{e.querySelector(".callout-title").addEventListener("click",(t=>{e.classList.contains("is-collapsed")?e.classList.remove("is-collapsed"):e.classList.add("is-collapsed")}))}))}))</script>
<script async src="https://fastly.jsdelivr.net/npm/force-graph@1.43.0/dist/force-graph.min.js"></script>
<script async src="https://fastly.jsdelivr.net/npm/@alpinejs/persist@3.11.1/dist/cdn.min.js"></script>
<script src="https://fastly.jsdelivr.net/npm/alpinejs@3.11.1/dist/cdn.min.js" async></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism-okaidia.min.css" integrity="sha512-mIs9kKbaw6JZFfSuo+MovjU+Ntggfoj8RwAmJbVXQ5mkAX5LlgETQEweFPI18humSPHymTb5iikEOKWF7I8ncQ==" crossorigin="anonymous" referrerpolicy="no-referrer" async>
<script src="https://fastly.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" async></script>
<link href="/styles/digital-garden-base.css" rel="stylesheet">
<link href="/styles/obsidian-base.css" rel="stylesheet">
<link href="/styles/_theme.d92311c2.css" rel="stylesheet">
<link href="/styles/custom-style.css" rel="stylesheet">
<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="manifest" href="/manifest.webmanifest">
<style></style>
</head>
<body class="theme-dark markdown-preview-view markdown-rendered markdown-preview-section">
<nav class="navbar">
<div class="navbar-inner">
<a href="/" style="text-decoration:none">
<h1 style="margin:15px!important">Digital Garden</h1>
</a>
</div>
</nav>
<main class="content cm-s-obsidian">
<header>
<div class="header-meta">
</div>
</header>
<h1 id="ingress" tabindex="-1">Ingress</h1>
<h2 id="what-is-ingress" tabindex="-1">What is Ingress?</h2>
<p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.28/#ingress-v1-networking-k8s-io" target="_blank" class="external-link">Ingress</a> exposes HTTP and HTTPS routes from outside the cluster to <a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank" class="external-link">services</a> within the cluster. Traffic routing is controlled by rules defined on the Ingress resource.</p>
<p>Here is a simple example where an Ingress sends all its traffic to one Service:</p>
<p>[<img src="https://kubernetes.io/docs/images/ingress.svg" alt="ingress-diagram"></p>
<p>An Ingress may be configured to give Services externally-reachable URLs, load balance traffic, terminate SSL / TLS, and offer name-based virtual hosting. An <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers" target="_blank" class="external-link">Ingress controller</a> is responsible for fulfilling the Ingress, usually with a load balancer, though it may also configure your edge router or additional frontends to help handle the traffic. Example ingress controllers are Nginx or HAProxy.</p>
<p>An Ingress does not expose arbitrary ports or protocols. Exposing services other than HTTP and HTTPS to the internet typically uses a service of type <a href="https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport" target="_blank" class="external-link">Service.Type=NodePort</a> or <a href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer" target="_blank" class="external-link">Service.Type=LoadBalancer</a>.</p>
<h2 id="creating-ingress" tabindex="-1">Creating Ingress</h2>
<h3 id="declarative-method" tabindex="-1">Declarative Method</h3>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: minimal-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx-example
  rules:
  - http:
      paths:
      - path: /testpath
        pathType: Prefix
        backend:
          service:
            name: test
            port:
              number: 80
</code></pre>
<h3 id="imperative-method" tabindex="-1">Imperative Method</h3>
<pre><code>$ kubectl create ingress ingress-test --rule=&quot;wear.my-online-store.com/wear*=wear-service:80**
</code></pre>
<h2 id="annotations-and-rewrite-target" tabindex="-1">Annotations and Rewrite Target</h2>
<p>Different ingress controllers have different options that can be used to customize the way it works. NGINX Ingress controller has many options that can be seen <a href="https://kubernetes.github.io/ingress-nginx/examples/" target="_blank" class="external-link">here</a>. I would like to explain one such option that we will use in our labs. The <a href="https://kubernetes.github.io/ingress-nginx/examples/rewrite/" target="_blank" class="external-link">Rewrite</a> target option.</p>
<p>Our <code>watch</code> app displays the video streaming webpage at <code>http://&lt;watch-service&gt;:&lt;port&gt;/</code></p>
<p>Our <code>wear</code> app displays the apparel webpage at <code>http://&lt;wear-service&gt;:&lt;port&gt;/</code></p>
<p>We must configure Ingress to achieve the below. When user visits the URL on the left, his/her request should be forwarded internally to the URL on the right. Note that the /watch and /wear URL path are what we configure on the ingress controller so we can forward users to the appropriate application in the backend. The applications don’t have this URL/Path configured on them:</p>
<p><code>http://&lt;ingress-service&gt;:&lt;ingress-port&gt;/watch</code> –&gt; <code>http://&lt;watch-service&gt;:&lt;port&gt;/</code></p>
<p><code>http://&lt;ingress-service&gt;:&lt;ingress-port&gt;/wear</code> –&gt; <code>http://&lt;wear-service&gt;:&lt;port&gt;/</code></p>
<p>Without the <code>rewrite-target</code> option, this is what would happen:</p>
<p><code>http://&lt;ingress-service&gt;:&lt;ingress-port&gt;/watch</code> –&gt; <code>http://&lt;watch-service&gt;:&lt;port&gt;/watch</code></p>
<p><code>http://&lt;ingress-service&gt;:&lt;ingress-port&gt;/wear</code> –&gt; <code>http://&lt;wear-service&gt;:&lt;port&gt;/wear</code></p>
<p>Notice <code>watch</code> and <code>wear</code> at the end of the target URLs. The target applications are not configured with <code>/watch</code> or <code>/wear</code> paths. They are different applications built specifically for their purpose, so they don’t expect <code>/watch</code> or <code>/wear</code> in the URLs. And as such the requests would fail and throw a <code>404</code> not found error.</p>
<p>To fix that we want to “ReWrite” the URL when the request is passed on to the watch or wear applications. We don’t want to pass in the same path that user typed in. So we specify the <code>rewrite-target</code> option. This rewrites the URL by replacing whatever is under <code>rules-&gt;http-&gt;paths-&gt;path</code> which happens to be <code>/pay</code> in this case with the value in <code>rewrite-target</code>. This works just like a search and replace function.</p>
<p>For example: <code>replace(path, rewrite-target)</code></p>
<p>In our case: <code>replace(&quot;/path&quot;,&quot;/&quot;)</code></p>
<pre><code>
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: test-ingress
  namespace: critical-space
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - http:
      paths:
      - path: /pay
        backend:
          serviceName: pay-service
          servicePort: 8282
</code></pre>
<p>In another example given <a href="https://kubernetes.github.io/ingress-nginx/examples/rewrite/" target="_blank" class="external-link">here</a>, this could also be:</p>
<p><code>replace(&quot;/something(/|$)(.*)&quot;, &quot;/$2&quot;)</code></p>
<pre><code>
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
  name: rewrite
  namespace: default
spec:
  rules:
  - host: rewrite.bar.com
    http:
      paths:
      - backend:
          serviceName: http-svc
          servicePort: 80
        path: /something(/|$)(.*)
</code></pre>
<hr>
<p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" class="external-link">https://kubernetes.io/docs/concepts/services-networking/ingress/</a></p>
</main>
<script>window.location.hash&&document.getElementById(window.location.hash.slice(1)).classList.add("referred"),window.addEventListener("hashchange",(e=>{const t=e.oldURL.split("#");t[1]&&document.getElementById(t[1]).classList.remove("referred");const n=e.newURL.split("#");n[1]&&document.getElementById(n[1]).classList.add("referred")}),!1);const url_parts=window.location.href.split("#"),url=url_parts[0],referrence=url_parts[1];document.querySelectorAll(".cm-s-obsidian > *[id]").forEach((function(e){e.ondblclick=function(e){const t=url+"#"+e.target.id;navigator.clipboard.writeText(t)}}))</script>
<script src="https://fastly.jsdelivr.net/npm/luxon@3.2.1/build/global/luxon.min.js"></script>
<script defer="defer">TIMESTAMP_FORMAT="MMM dd, yyyy h:mm a",document.querySelectorAll(".human-date").forEach((function(e){date=e.getAttribute("data-date")||e.innerText,parsed_date=luxon.DateTime.fromISO(date),null!=parsed_date.invalid&&(parsed_date=luxon.DateTime.fromSQL(date)),null!=parsed_date.invalid&&(parsed_date=luxon.DateTime.fromHTML(date)),e.innerHTML=parsed_date.toFormat(TIMESTAMP_FORMAT)}))</script>
<script>lucide.createIcons({attrs:{class:["svg-icon"]}})</script>
</body>
</html>
